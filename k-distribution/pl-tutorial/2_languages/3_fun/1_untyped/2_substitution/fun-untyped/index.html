<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="K | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://kframework.org/k-distribution/pl-tutorial/2_languages/3_fun/1_untyped/2_substitution/fun-untyped/" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../../../../../assets/img/favicon.ico" />

<title>K | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../../../../index.html">
    <img
      class="logo-dark"
      srcset="../../../../../../../assets/img/k-logo.png"
      alt="K"
      style="height: 48px;"
    />
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/kframework/k"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../../../../../../../downloads"
    >Download</a
  >
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../../../../../../../">Homepage</a>
      <a class="bd-toc-link" href="../../../../../../../downloads">K Tool Binaries </a>
      <a class="bd-toc-link" href="../../../../../../../k-distribution/k-tutorial"
        >K Tutorial</a
      >
      <a class="bd-toc-link" href="../../../../../../../k-distribution/pl-tutorial"
        >K PL Tutorial</a
      >
      <a class="bd-toc-link" href="../../../../../../../USER_MANUAL/">K User Manual </a>
      <a
        class="bd-toc-link"
        href="../../../../../../../k-distribution/include/kframework/builtin/"
        >K Builtins
      </a>
      <a class="bd-toc-link" href="../../../../../../../projects">Projects using K</a>
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-6 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="introduction markdown-preview"><html><head></head><body><h1 id="fun-%E2%80%94-untyped-%E2%80%94-substitution">FUN &#x2014; Untyped &#x2014; Substitution</h1>
<p>Author: Grigore Ro&#x219;u (<a href="mailto:grosu@illinois.edu" target="_blank" rel="noopener">grosu@illinois.edu</a>)<br>
Organization: University of Illinois at Urbana-Champaign</p>
<p>Author: Traian Florin &#x218;erb&#x103;nu&#x21B;&#x103; (<a href="mailto:traian.serbanuta@unibuc.ro" target="_blank" rel="noopener">traian.serbanuta@unibuc.ro</a>)<br>
Organization: University of Bucharest</p>
<h2 id="abstract">Abstract</h2>
<p>This is the substitution-based definition of FUN.  For additional
explanations regarding the semantics of the various FUN constructs,
the reader should consult the emvironment-based definition of FUN.</p>
<h2 id="syntax">Syntax</h2>
<pre class="language-k"><code><span class="token keyword">require</span> <span class="token string">&quot;substitution.md&quot;</span>
<span class="token comment">//require &quot;modules/pattern-matching.k&quot;</span>

<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> DOMAINS<span class="token operator">-</span>SYNTAX
</code></pre>
<h2 id="the-syntactic-constructs">The Syntactic Constructs</h2>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Name
  <span class="token keyword">syntax</span> Names <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Name<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span> <span class="token operator">|</span> Name
               <span class="token operator">|</span> <span class="token string">&quot;(&quot;</span> Exp <span class="token string">&quot;)&quot;</span>                       <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Exps  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Exp<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>                   <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Val<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;*&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;/&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;%&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               &gt; <span class="token class-name">left</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;+&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;^&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;-&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">prefer</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">&quot;-&quot;</span> Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               &gt; <span class="token class-name">non-assoc</span><span class="token punctuation">:</span>
                 Exp <span class="token string">&quot;&lt;&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&lt;=&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&gt;&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;&gt;=&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;==&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;!=&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               &gt; <span class="token string">&quot;!&quot;</span> Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               &gt; Exp <span class="token string">&quot;&amp;&amp;&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>
               &gt; Exp <span class="token string">&quot;||&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">,</span> arith<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;if&quot;</span> Exp <span class="token string">&quot;then&quot;</span> Exp <span class="token string">&quot;else&quot;</span> Exp    <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;[&quot;</span> Exps <span class="token string">&quot;]&quot;</span>                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> <span class="token string">&quot;cons&quot;</span> <span class="token operator">|</span>  <span class="token string">&quot;head&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;tail&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;null?&quot;</span>
               <span class="token operator">|</span> <span class="token string">&quot;[&quot;</span> Exps <span class="token string">&quot;|&quot;</span> Exp <span class="token string">&quot;]&quot;</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;[&quot;</span> Vals <span class="token string">&quot;]&quot;</span>

  <span class="token keyword">syntax</span> ConstructorName
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName
               <span class="token operator">|</span> ConstructorName <span class="token string">&quot;(&quot;</span> Exps <span class="token string">&quot;)&quot;</span>      <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">,</span> <span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName <span class="token string">&quot;(&quot;</span> Vals <span class="token string">&quot;)&quot;</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;fun&quot;</span> Cases
               <span class="token operator">|</span> Exp Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> <span class="token class-name">left</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Case  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Exp <span class="token string">&quot;-&gt;&quot;</span> Exp                    <span class="token punctuation">[</span><span class="token class-name">binder</span><span class="token punctuation">]</span>
<span class="token comment">// NOTE: The binder attribute above is the only difference between this</span>
<span class="token comment">// module and the syntax module of environment-based FUN.  We need</span>
<span class="token comment">// to fix a bug in order to import modules and override the attributes</span>
<span class="token comment">// of operations.</span>
  <span class="token keyword">syntax</span> Cases <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Case<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;let&quot;</span> Bindings <span class="token string">&quot;in&quot;</span> Exp
               <span class="token operator">|</span> <span class="token string">&quot;letrec&quot;</span> Bindings <span class="token string">&quot;in&quot;</span> Exp                 <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Binding  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Exp <span class="token string">&quot;=&quot;</span> Exp
  <span class="token keyword">syntax</span> Bindings <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Binding<span class="token punctuation">,</span><span class="token string">&quot;and&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;ref&quot;</span>
               <span class="token operator">|</span> <span class="token string">&quot;&amp;&quot;</span> Name
               <span class="token operator">|</span> <span class="token string">&quot;@&quot;</span> Exp                           <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;:=&quot;</span> Exp                      <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">]</span>
               <span class="token operator">|</span> Exp <span class="token string">&quot;;&quot;</span> Exp                       <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">right</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;callcc&quot;</span>
               <span class="token operator">|</span> <span class="token string">&quot;try&quot;</span> Exp <span class="token string">&quot;catch&quot;</span> <span class="token string">&quot;(&quot;</span> Name <span class="token string">&quot;)&quot;</span> Exp
  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;throw&quot;</span> <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;datatype&quot;</span> Type <span class="token string">&quot;=&quot;</span> TypeCases Exp

  <span class="token keyword">syntax</span> TypeVar
  <span class="token keyword">syntax</span> TypeVars <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>TypeVar<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>

  <span class="token keyword">syntax</span> TypeName
  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;int&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;bool&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;string&quot;</span>
                <span class="token operator">|</span> Type <span class="token string">&quot;--&gt;&quot;</span> Type                            <span class="token punctuation">[</span><span class="token class-name">right</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;(&quot;</span> Type <span class="token string">&quot;)&quot;</span>                             <span class="token punctuation">[</span><span class="token class-name">bracket</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> TypeVar
                <span class="token operator">|</span> TypeName             <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>TypeName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">avoid</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> Type TypeName   <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>Type<span class="token operator">-</span>TypeName<span class="token punctuation">)</span><span class="token punctuation">,</span> onlyLabel<span class="token punctuation">]</span>
                <span class="token operator">|</span> <span class="token string">&quot;(&quot;</span> Types <span class="token string">&quot;)&quot;</span> TypeName                    <span class="token punctuation">[</span><span class="token class-name">prefer</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Types <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>Type<span class="token punctuation">,</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">}</span>
  <span class="token keyword">syntax</span> Types <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TypeVars

  <span class="token keyword">syntax</span> TypeCase <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName
                    <span class="token operator">|</span> ConstructorName <span class="token string">&quot;(&quot;</span> Types <span class="token string">&quot;)&quot;</span>
  <span class="token keyword">syntax</span> TypeCases <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> List<span class="token punctuation">{</span>TypeCase<span class="token punctuation">,</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">}</span>     <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>_<span class="token operator">|</span>TypeCase_<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<h2 id="additional-priorities">Additional Priorities</h2>
<pre class="language-k"><code>  <span class="token keyword">syntax priorities</span> @__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; ___FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; arith
                  &gt; _<span class="token punctuation">:</span><span class="token operator">=</span>__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; let_in__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                    letrec_in__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                    if_then_else__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; _<span class="token punctuation">;</span>__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; fun__FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
                  &gt; datatype_<span class="token operator">=</span>___FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
<span class="token keyword">endmodule</span>

<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>MACROS
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
</code></pre>
<h2 id="desugaring-macros">Desugaring macros</h2>
<pre class="language-k"><code>  <span class="token keyword">rule</span> P1 P2 <span class="token operator">-</span>&gt; E <span class="token operator">=&gt;</span> P1 <span class="token operator">-</span>&gt; fun P2 <span class="token operator">-</span>&gt; E                       <span class="token punctuation">[</span><span class="token class-name">macro-rec</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> F P <span class="token operator">=</span> E <span class="token operator">=&gt;</span> F <span class="token operator">=</span> fun P <span class="token operator">-</span>&gt; E                             <span class="token punctuation">[</span><span class="token class-name">macro-rec</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token punctuation">[</span>E1<span class="token punctuation">,</span>E2<span class="token punctuation">,</span>Es<span class="token punctuation">:</span>Exps<span class="token operator">|</span>T<span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>E1<span class="token operator">|</span><span class="token punctuation">[</span>E2<span class="token punctuation">,</span>Es<span class="token operator">|</span>T<span class="token punctuation">]</span><span class="token punctuation">]</span>                   <span class="token punctuation">[</span><span class="token class-name">macro-rec</span><span class="token punctuation">]</span>

<span class="token comment">//  rule &apos;TypeName(Tn:TypeName) =&gt; (.TypeVars) Tn              [macro]</span>
  <span class="token keyword">rule</span> `Type<span class="token operator">-</span>TypeName`<span class="token punctuation">(</span>T<span class="token punctuation">:</span>Type<span class="token punctuation">,</span> Tn<span class="token punctuation">:</span>TypeName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> Tn          <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;$h&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;$t&quot;</span>
  <span class="token keyword">rule</span> head <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; $h                             <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> tail <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; $t                             <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> null<span class="token operator">?</span> <span class="token operator">=&gt;</span> fun <span class="token punctuation">[</span><span class="token punctuation">.</span>Exps<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token punctuation">[</span>$h<span class="token operator">|</span>$t<span class="token punctuation">]</span> <span class="token operator">-</span>&gt; <span class="token boolean">false</span>       <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;$k&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;$v&quot;</span>
  <span class="token keyword">rule</span> try E catch<span class="token punctuation">(</span>X<span class="token punctuation">)</span> E&apos;
    <span class="token operator">=&gt;</span> callcc <span class="token punctuation">(</span>fun $k <span class="token operator">-</span>&gt; <span class="token punctuation">(</span>fun throw <span class="token operator">-</span>&gt; E<span class="token punctuation">)</span><span class="token punctuation">(</span>fun X <span class="token operator">-</span>&gt; $k E&apos;<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>

  <span class="token keyword">rule</span> datatype _T <span class="token operator">=</span> _TCs E <span class="token operator">=&gt;</span> E                               <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
</code></pre>
<p>mu needed for letrec, but we put it here so we can also write
programs with mu in them, which is particularly useful for testing.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;mu&quot;</span> Case

<span class="token keyword">endmodule</span>


<span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>SYNTAX
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> BUILTIN<span class="token operator">-</span>ID<span class="token operator">-</span>TOKENS

  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> r<span class="token string">&quot;[a-z][_a-zA-Z0-9]*&quot;</span>            <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">,</span> prec<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token operator">|</span> #LowerId                         <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> ConstructorName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #UpperId              <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> TypeVar  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> r<span class="token string">&quot;[&apos;][a-z][_a-zA-Z0-9]*&quot;</span>     <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Name                         <span class="token punctuation">[</span><span class="token class-name">token</span><span class="token punctuation">]</span>
<span class="token keyword">endmodule</span>
</code></pre>
<h2 id="semantics">Semantics</h2>
<pre class="language-k"><code><span class="token keyword">module</span> FUN<span class="token operator">-</span>UNTYPED
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> FUN<span class="token operator">-</span>UNTYPED<span class="token operator">-</span>MACROS
  <span class="token keyword">imports</span> DOMAINS
  <span class="token keyword">imports</span> SUBSTITUTION
  <span class="token comment">//imports PATTERN-MATCHING</span>

  <span class="token keyword">configuration</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yellow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>green<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> $PGM<span class="token punctuation">:</span>Exp <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>white<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Both Name and functions are values now:</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Int</span> <span class="token operator">|</span> <span class="token keyword">Bool</span> <span class="token operator">|</span> <span class="token keyword">String</span> <span class="token operator">|</span> Name
  <span class="token keyword">syntax</span> Exp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Val
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Names
  <span class="token keyword">syntax</span> Vals <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Names

  <span class="token keyword">rule</span> I1 <span class="token operator">*</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">/</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2 when I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">%</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2 when I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K <span class="token number">0</span>
  <span class="token keyword">rule</span> I1 <span class="token operator">+</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> S1 <span class="token operator">^</span> S2 <span class="token operator">=&gt;</span> S1 <span class="token operator">+</span><span class="token keyword">String</span> S2
  <span class="token keyword">rule</span> I1 <span class="token operator">-</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> <span class="token operator">-</span> I <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token operator">-</span><span class="token keyword">Int</span> I
  <span class="token keyword">rule</span> I1 &lt; I2 <span class="token operator">=&gt;</span> I1 &lt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&lt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&lt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 &gt; I2 <span class="token operator">=&gt;</span> I1 &gt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> I1 <span class="token operator">&gt;=</span> I2 <span class="token operator">=&gt;</span> I1 <span class="token operator">&gt;=</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">==</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">==</span>K V2
  <span class="token keyword">rule</span> V1<span class="token punctuation">:</span>Val <span class="token operator">!=</span> V2<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V1 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span>K V2
  <span class="token keyword">rule</span> <span class="token operator">!</span> T <span class="token operator">=&gt;</span> notBool<span class="token punctuation">(</span>T<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">&amp;&amp;</span> E <span class="token operator">=&gt;</span> E
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> <span class="token boolean">true</span>  <span class="token operator">||</span> _ <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token boolean">false</span> <span class="token operator">||</span> E <span class="token operator">=&gt;</span> E

  <span class="token keyword">rule</span> if  <span class="token boolean">true</span> then E else _ <span class="token operator">=&gt;</span> E
  <span class="token keyword">rule</span> if <span class="token boolean">false</span> then _ else E <span class="token operator">=&gt;</span> E

  <span class="token keyword">rule</span> isVal<span class="token punctuation">(</span>cons<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isVal<span class="token punctuation">(</span>cons _V<span class="token punctuation">:</span>Val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> cons V<span class="token punctuation">:</span>Val <span class="token punctuation">[</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>V<span class="token punctuation">,</span>Vs<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> ConstructorName

  <span class="token keyword">rule</span> isVal<span class="token punctuation">(</span>fun _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">syntax</span> KVar <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Name
  <span class="token keyword">syntax</span> Name <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> freshName<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span>freshGenerator<span class="token punctuation">,</span> function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> freshName<span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>#parseToken<span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;#&quot;</span> <span class="token operator">+</span><span class="token keyword">String</span> Int2String<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Name

  <span class="token keyword">rule</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> <span class="token operator">=&gt;</span> getMatching<span class="token punctuation">(</span>P<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>fun P<span class="token operator">-</span>&gt;_ <span class="token operator">|</span> _<span class="token punctuation">)</span> V<span class="token punctuation">:</span>Val
  <span class="token keyword">rule</span> matchResult<span class="token punctuation">(</span>M<span class="token punctuation">:</span>Map<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>fun _<span class="token operator">-</span>&gt;E <span class="token operator">|</span> _<span class="token punctuation">)</span> _ <span class="token operator">=&gt;</span> E<span class="token punctuation">[</span>M<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token punctuation">(</span>matchFailure <span class="token operator">=&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>fun <span class="token punctuation">(</span>_<span class="token operator">-</span>&gt;_ <span class="token operator">|</span> Cs<span class="token punctuation">:</span>Cases <span class="token operator">=&gt;</span> Cs<span class="token punctuation">)</span><span class="token punctuation">)</span> _
<span class="token comment">//  rule (fun P-&gt;E | _) V:Val =&gt; E[getMatching(P,V)]  when isMatching(P,V)</span>
<span class="token comment">//  rule (fun (P-&gt;_ | Cs:Cases =&gt; Cs)) V:Val  when notBool isMatching(P,V)</span>
</code></pre>
<p>We can reduce multiple bindings to one list binding, and then
apply the usual desugaring of let into function application.
It is important that the rule below is a macro, so let is eliminated
immediately, otherwise it may interfere in ugly ways with substitution.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> let Bs in E <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fun <span class="token punctuation">[</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span>&gt; E<span class="token punctuation">)</span> <span class="token punctuation">[</span>exps<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
</code></pre>
<p>We only give the semantics of one-binding letrec.
Multipe bindings are left as an exercise.</p>
<pre class="language-k"><code>  <span class="token comment">// changed because of parsing error</span>
  <span class="token comment">//rule mu X:Name -&gt; E =&gt; E[(mu X -&gt; E) / X]</span>
  <span class="token keyword">rule</span> mu X<span class="token punctuation">:</span>Name <span class="token operator">-</span>&gt; E <span class="token operator">=&gt;</span> E<span class="token punctuation">[</span>X <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>mu X <span class="token operator">-</span>&gt; E<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> letrec F<span class="token punctuation">:</span>Name <span class="token operator">=</span> E in E<span class="token string">&apos; =&gt; let F = (mu F -&gt; E) in E&apos;</span>  <span class="token punctuation">[</span><span class="token class-name">macro</span><span class="token punctuation">]</span>
</code></pre>
<p>We cannot have <code>&amp;</code> anymore, but we can give direct
semantics to <code>ref</code>.  We also have to declare <code>ref</code> to
be a value, so that we will never heat on it.</p>
<pre class="language-k"><code><span class="token comment">//  rule &lt;k&gt; &amp; X =&gt; L ...&lt;/k&gt;  &lt;env&gt;... X |-&gt; L &lt;/env&gt;</span>
  <span class="token keyword">rule</span> isVal<span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ref V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> <span class="token operator">!</span>L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> <span class="token operator">!</span>L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> @ L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token operator">=&gt;</span> V<span class="token punctuation">:</span>Val <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> L<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token operator">=</span> V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>store</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> L <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">(</span>_<span class="token operator">=&gt;</span>V<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>store</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> _V<span class="token punctuation">:</span>Val<span class="token punctuation">;</span> E <span class="token operator">=&gt;</span> E

  <span class="token keyword">syntax</span> Val <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> cc<span class="token punctuation">(</span>K<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isVal<span class="token punctuation">(</span>callcc<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>callcc V<span class="token punctuation">:</span>Val <span class="token operator">=&gt;</span> V cc<span class="token punctuation">(</span>K<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> cc<span class="token punctuation">(</span>K<span class="token punctuation">)</span> V<span class="token punctuation">:</span>Val <span class="token operator">~&gt;</span> _ <span class="token operator">=&gt;</span> V <span class="token operator">~&gt;</span> K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Auxiliary getters</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Names <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> names<span class="token punctuation">(</span>Bindings<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> names<span class="token punctuation">(</span><span class="token punctuation">.</span>Bindings<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Names
  <span class="token keyword">rule</span> names<span class="token punctuation">(</span>X<span class="token punctuation">:</span>Name<span class="token operator">=</span>_ and Bs<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> X<span class="token punctuation">,</span>names<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> exps<span class="token punctuation">(</span>Bindings<span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> exps<span class="token punctuation">(</span><span class="token punctuation">.</span>Bindings<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Exps
  <span class="token keyword">rule</span> exps<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Name<span class="token operator">=</span>E and Bs<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> E<span class="token punctuation">,</span>exps<span class="token punctuation">(</span>Bs<span class="token punctuation">)</span>

  <span class="token comment">/* Extra kore stuff */</span>
  <span class="token keyword">syntax</span> KResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Vals
  <span class="token keyword">syntax</span> Exps <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Names

  <span class="token comment">/* Matching */</span>
  <span class="token keyword">syntax</span> MatchResult <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> getMatching<span class="token punctuation">(</span>Exp<span class="token punctuation">,</span> Val<span class="token punctuation">)</span>                      <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> getMatchingAux<span class="token punctuation">(</span>Exps<span class="token punctuation">,</span> Vals<span class="token punctuation">)</span>                 <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> mergeMatching<span class="token punctuation">(</span>MatchResult<span class="token punctuation">,</span> MatchResult<span class="token punctuation">)</span>    <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                       <span class="token operator">|</span> matchResult<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
                       <span class="token operator">|</span> <span class="token string">&quot;matchFailure&quot;</span>

  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>C<span class="token punctuation">:</span>ConstructorName<span class="token punctuation">(</span>Es<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">,</span> C<span class="token punctuation">(</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span><span class="token punctuation">[</span>Es<span class="token punctuation">:</span>Exps<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>C<span class="token punctuation">:</span>ConstructorName<span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>B<span class="token punctuation">:</span><span class="token keyword">Bool</span><span class="token punctuation">,</span> B<span class="token punctuation">)</span>            <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>I<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> I<span class="token punctuation">)</span>             <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>S<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span>          <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>N<span class="token punctuation">:</span>Name<span class="token punctuation">,</span> V<span class="token punctuation">:</span>Val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span>N <span class="token operator">|</span><span class="token operator">-</span>&gt; V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure        <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">(</span>E<span class="token punctuation">:</span>Exp<span class="token punctuation">,</span> Es<span class="token punctuation">:</span>Exps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> mergeMatching<span class="token punctuation">(</span>getMatching<span class="token punctuation">(</span>E<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> getMatchingAux<span class="token punctuation">(</span>Es<span class="token punctuation">,</span> Vs<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">.</span>Exps<span class="token punctuation">,</span> <span class="token punctuation">.</span>Vals<span class="token punctuation">)</span>                       <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> getMatchingAux<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure     <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchResult<span class="token punctuation">(</span>M1<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">,</span> matchResult<span class="token punctuation">(</span>M2<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchResult<span class="token punctuation">(</span>M1 M2<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> intersectSet<span class="token punctuation">(</span>keys<span class="token punctuation">(</span>M1<span class="token punctuation">)</span><span class="token punctuation">,</span> keys<span class="token punctuation">(</span>M2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span>K <span class="token punctuation">.</span>Set
  <span class="token comment">//rule mergeMatching(_, _) =&gt; matchFailure      [owsie]</span>
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchResult<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">,</span> matchFailure<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchFailure<span class="token punctuation">,</span> matchResult<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> matchFailure
  <span class="token keyword">rule</span> mergeMatching<span class="token punctuation">(</span>matchFailure<span class="token punctuation">,</span> matchFailure<span class="token punctuation">)</span>       <span class="token operator">=&gt;</span> matchFailure
</code></pre>
<p>Besides the generic decomposition rules for patterns and values,
we also want to allow <code>[head|tail]</code> matching for lists, so we add
the following custom pattern decomposition rule:</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> getMatching<span class="token punctuation">(</span><span class="token punctuation">[</span>H<span class="token punctuation">:</span>Exp <span class="token operator">|</span> T<span class="token punctuation">:</span>Exp<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>V<span class="token punctuation">:</span>Val<span class="token punctuation">,</span> Vs<span class="token punctuation">:</span>Vals<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> getMatchingAux<span class="token punctuation">(</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> <span class="token punctuation">[</span>Vs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">endmodule</span>
</code></pre>
</body></html></div>
        </main>

        <!-- Page ToC -->
        <div class="col-12 col-md-3 col-xl-2 py-md-3 bd-sidebar page-toc mb-3">
          
<div>
<details style="padding:0.25rem 0;;padding-left: 0px;" open>
            <summary class="bd-toc-link-wrapper">
              <a href="#fun-%E2%80%94-untyped-%E2%80%94-substitution" class="bd-toc-link">FUN &#x2014; Untyped &#x2014; Substitution</a>
              </summary>
            <div>
              <div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#abstract"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Abstract
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#syntax"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Syntax
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#the-syntactic-constructs"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                The Syntactic Constructs
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#additional-priorities"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Additional Priorities
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#desugaring-macros"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Desugaring macros
              </a></div><div class="bd-toc-link-wrapper" style="padding:0.25rem 0;">
              <a
                href="#semantics"
                class="bd-toc-link"
                style="padding-left: 8px;;"
              >
                Semantics
              </a></div>
            </div>
          </details>
        
</div>

        </div>
        <div class="btn btn-rv-blue page-toc-toggle-btn"></div>
        <!-- End Page ToC -->
      </div>
    </div>
<!-- The footer is now controlled by the k-web-theme git submodule -->
<footer id="rvsite-footer" class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-4 mb-md-0 mb-4">
        <a href="https://runtimeverification.com/" target="_blank">
          <picture>
            <source
              srcset="
                https://runtimeverification.com/assets/img/rv-logo-dark.png
              "
              media="(prefers-color-scheme: dark)"
            />
            <img
              class="logo-dark"
              src="https://runtimeverification.com/assets/img/rv-logo.png"
              alt="Runtime Verification logo"
              style="height: 32px"
            /> </picture
        ></a>
        <p class="mt-2 text-md-left copyright">
          <a href="https://goo.gl/maps/NYzr2iKpXMgEmQ2F6" target="_blank"
            >102 E Main St #500, Urbana, IL 61801</a
          >
        </p>
      </div>
      <div class="col-md-4 text-md-center mb-md-0 mb-4"></div>
      <div class="col-md-4 mb-md-0 mb-4 text-md-right">
        <p class="copyright">2021  all rights reserved</p>
      </div>
    </div>
  </div>
</footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../../../../assets/js/index.js"></script>
    <script>
      $(function () {
        // Render youtube video
        const anchorElements = document.querySelectorAll(".markdown-preview a");
        for (let i = anchorElements.length - 1; i >= 0; i--) {
          if (anchorElements.length - 1 - i > 3) {
            break;
          }
          const anchorElement = anchorElements[i];
          const href = anchorElement.getAttribute("href");
          if (href.match(/^https?:\/\/youtu.be\//)) {
            const match = href.match(/^https?:\/\/youtu.be\/(.+?)$/);
            if (match && match[1]) {
              const youtubeId = match[1];
              const $iframe = $(`
<div style="text-align:center;">
  <iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/${youtubeId}"
    frameborder="0"
    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
    style="max-width: 100%;"
  ></iframe>
  <p>The video is out of date</p>
</div>
`);
              $(anchorElement).replaceWith($iframe[0]);
            }
          }
        }
      });
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9LBGDMRG32"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9LBGDMRG32");
    </script>
  </body>
</html>
